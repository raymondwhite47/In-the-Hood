# Deployment & Environment Configuration

This document captures the current AWS/Amplify footprint in the repo, the environment map, and a repeatable deployment approach for `dev`, `stage`, and `prod`.

## 1) Current AWS stack components by environment

**What’s in the repo today**

| Component | Evidence in repo | Notes |
| --- | --- | --- |
| **Amplify project** | `amplify/` directory | Amplify CLI project is initialized. |
| **AppSync GraphQL API** | `amplify/backend/api/inthehood/schema.graphql` | GraphQL schema is present. When deployed, Amplify creates an AppSync API and DynamoDB tables for the models. |
| **DynamoDB (via AppSync)** | Implicit from GraphQL models in `schema.graphql` | Tables are generated when the API is deployed. |
| **Cognito** | Not present in `amplify/backend/auth` | No Auth category configured in this repo yet. |
| **S3 Storage** | Not present in `amplify/backend/storage` | No Storage category configured in this repo yet. |
| **API Gateway / Lambda** | `amplify/backend/function/inthehoodProcessAuction` | Lambda function is configured for auction processing (no API Gateway configured). |

**Environment map (from `amplify/team-provider-info.json`)**

| Environment | Status | Amplify stack name | Region | Amplify App ID |
| --- | --- | --- | --- | --- |
| `dev` | ✅ configured | `amplify-inthehood-dev-ca697` | `us-west-1` | `d1k7whenqv7rni` |
| `stage` | ⚠️ not configured | — | — | — |
| `prod` | ⚠️ not configured | — | — | — |

> Only `dev` is currently configured in the repo. `stage` and `prod` will need to be added with Amplify CLI (`amplify env add`) before they can be deployed.

## 2) Amplify/AWS configuration locations

| File/Folder | Purpose |
| --- | --- |
| `amplify/` | Amplify CLI project configuration. |
| `amplify/team-provider-info.json` | Per-environment stack metadata (current: `dev` only). |
| `amplify/backend/api/inthehood/schema.graphql` | GraphQL schema for the API category. |
| `In_the_Hood/lib/amplifyconfiguration.dart` | Generated runtime config for the Flutter app. Currently empty placeholders. |

## 3) Environment-specific settings to define

These values are generated by Amplify when environments are deployed and should be tracked per environment:

| Setting | `dev` | `stage` | `prod` | Source of truth |
| --- | --- | --- | --- | --- |
| AppSync GraphQL endpoint | _TBD_ | _TBD_ | _TBD_ | `amplifyconfiguration.dart` (generated) |
| AppSync API key (if used) | _TBD_ | _TBD_ | _TBD_ | `amplifyconfiguration.dart` (generated) |
| Cognito User Pool ID | _TBD_ | _TBD_ | _TBD_ | `amplifyconfiguration.dart` (generated) |
| Cognito App Client IDs | _TBD_ | _TBD_ | _TBD_ | `amplifyconfiguration.dart` (generated) |
| S3 bucket name | _TBD_ | _TBD_ | _TBD_ | `amplifyconfiguration.dart` (generated) |
| Region | `us-west-1` | _TBD_ | _TBD_ | `amplify/team-provider-info.json` |

**Recommended pattern:**
- Use **Amplify environments** (`dev`, `stage`, `prod`) to generate the correct `amplifyconfiguration.dart` for each build.
- Optionally store sensitive or environment-specific values in **AWS SSM Parameter Store** and inject them into CI/CD at build time.

## 4) Repeatable deploy pipeline (Amplify CLI + CI)

### A. Local/CLI workflow

```bash
# one-time init (if not already initialized)
amplify init

# add environments
amplify env add stage
amplify env add prod

# deploy the backend for each environment
amplify env checkout dev
amplify push

amplify env checkout stage
amplify push

amplify env checkout prod
amplify push
```

Generate the app configuration for each environment:

```bash
# pull backend env config and write amplifyconfiguration.dart
amplify pull --envName dev
amplify pull --envName stage
amplify pull --envName prod
```

### B. CI workflow (example)

**Recommended inputs (GitHub Actions secrets):**
- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION`
- `AMPLIFY_APP_ID`
- `AMPLIFY_ENV` (dev/stage/prod)

**Example steps (conceptual):**

```yaml
- name: Install Amplify CLI
  run: npm install -g @aws-amplify/cli

- name: Configure AWS
  run: |
    aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    aws configure set region $AWS_REGION

- name: Pull Amplify backend
  run: amplify pull --appId $AMPLIFY_APP_ID --envName $AMPLIFY_ENV --yes

- name: Deploy backend
  run: amplify push --yes
```

**Parameter Store pattern (optional):**
- Store values such as `APP_SYNC_API_URL`, `COGNITO_USER_POOL_ID`, `S3_BUCKET` per environment in **SSM Parameter Store**.
- In CI, read the parameters and inject them into the build (for example via `.env` or build-time dart-define flags).

## 5) Environment setup checklist

1. **Create Amplify environments**: `dev`, `stage`, `prod`.
2. **Deploy the backend** in each environment (`amplify push`).
3. **Pull config** for each environment to update `In_the_Hood/lib/amplifyconfiguration.dart`.
4. **Record environment values** in your internal secrets store or Parameter Store.
5. **Update CI** to deploy based on branch → environment mapping (e.g., `main` → `prod`, `develop` → `dev`).

## 6) Direct DynamoDB access in Lambda (AWS SDK)

If you want to read/write DynamoDB directly inside a Lambda (for example, `inthehoodProcessAuction`), use the AWS SDK DocumentClient and reference the table name from environment variables set by Amplify.

**Node.js example:**

```js
const AWS = require("aws-sdk");
const ddb = new AWS.DynamoDB.DocumentClient();

exports.handler = async () => {
  const params = {
    TableName: process.env.AUCTION_TABLE_NAME, // provided by Amplify
    Key: { id: "auction1" },
  };

  const result = await ddb.get(params).promise();
  console.log("Auction:", result.Item);
  return result.Item;
};
```

**Notes:**
- Amplify model tables are created per environment and generally follow `Auction-<environmentId>`, `Post-<environmentId>`, etc.
- You can confirm the exact table names in the AWS Console under **DynamoDB → Tables**.
